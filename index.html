<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Télécharger Mon Super Jeu</title>
    <!-- Chargement de la police Inter depuis Google Fonts pour un look moderne -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Chargement de Font Awesome pour les icônes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* Styles globaux pour le corps de la page */
        body {
            font-family: 'Inter', sans-serif; /* Utilise la police Inter */
            line-height: 1.6;
            margin: 0;
            padding: 0;
            /* Fond dégradé doux pour un aspect moderne */
            background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
            color: #333;
            display: flex;
            flex-direction: column; /* Organise le contenu en colonne */
            min-height: 100vh; /* Prend toute la hauteur de la fenêtre */
            align-items: center; /* Centre le contenu horizontalement */
        }

        /* Barre de navigation */
        .navbar {
            width: 100%;
            background-color: #2c3e50; /* Couleur sombre pour la barre */
            padding: 15px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            text-align: center;
        }
        .navbar a {
            color: white;
            text-decoration: none;
            font-weight: 600;
            margin: 0 20px;
            font-size: 1.1em;
            transition: color 0.3s ease;
        }
        .navbar a:hover {
            color: #a8dadc; /* Couleur au survol */
        }

        /* Conteneurs principaux : en-tête, contenu, pied de page */
        .header, .main-content, .footer {
            width: 100%;
            max-width: 960px; /* Largeur maximale pour le contenu */
            margin: 0 auto; /* Centre le bloc */
            box-sizing: border-box; /* Inclut le padding dans la largeur/hauteur totale */
            padding: 20px;
        }

        /* Section d'en-tête */
        .header {
            background-color: #ffffff;
            padding: 40px 20px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-radius: 10px; /* Coins arrondis */
            margin-top: 20px; /* Marge supérieure pour l'en-tête */
        }
        .header h1 {
            color: #2c3e50;
            font-size: 2.8em;
            margin-bottom: 10px;
        }
        .header p {
            color: #666;
            font-size: 1.1em;
        }

        /* Styles pour les images dans le contenu */
        .content-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 20px auto; /* Centre l'image et ajoute de la marge */
            display: block; /* S'assure que margin auto fonctionne */
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* Contenu principal */
        .main-content {
            flex-grow: 1; /* Permet au contenu de s'étendre et de pousser le pied de page vers le bas */
            padding: 40px 20px;
        }

        /* Style des sections de documentation */
        .section {
            background-color: #ffffff;
            padding: 30px;
            margin-bottom: 30px;
            border-radius: 10px; /* Coins arrondis */
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* Ombre légère */
        }

        .section h2 {
            color: #007bff; /* Couleur bleue pour les titres de section */
            font-size: 2em;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0; /* Soulignement des titres */
            padding-bottom: 10px;
        }

        .section p, .section ul, .section ol {
            font-size: 1.05em;
            color: #555;
            margin-bottom: 15px;
        }

        .section ul, .section ol {
            padding-left: 25px; /* Indentation pour les listes */
        }

        .section ul li, .section ol li {
            margin-bottom: 10px;
        }

        /* Conteneur du bouton de téléchargement pour le centrer */
        .download-button-container {
            text-align: center;
            margin-top: 30px;
            margin-bottom: 40px;
        }

        /* Style du bouton de téléchargement */
        .download-button {
            display: inline-flex; /* Permet d'aligner l'icône et le texte */
            align-items: center;
            gap: 10px; /* Espace entre l'icône et le texte */
            background-color: #28a745; /* Vert pour le bouton */
            color: white;
            padding: 18px 40px;
            border: none; /* Supprime la bordure par défaut */
            border-radius: 8-px; /* Plus arrondi */
            text-decoration: none;
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer; /* Indique que l'élément est cliquable */
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }
        .download-button:hover {
            background-color: #218838;
            transform: translateY(-3px);
        }
        .download-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(40, 167, 69, 0.3);
        }

        /* Style du message d'avertissement */
        .warning {
            margin-top: 20px;
            font-size: 0.95em;
            color: #888;
            background-color: #fff3cd;
            border-left: 5px solid #ffc107;
            padding: 15px;
            border-radius: 5px;
        }
        .warning strong {
            color: #da9f04;
        }

        /* Styles pour le clicker */
        .clicker-container {
            text-align: center;
            padding: 30px;
            background-color: #e0f2f7;
            border-radius: 10px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
            margin-top: 30px;
        }
        .clicker-container h2 {
            color: #0056b3;
            margin-bottom: 20px;
            border-bottom: none;
        }
        .clicker-display {
            font-size: 3em;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 20px;
            padding: 10px 20px;
            background-color: #ffffff;
            border-radius: 5px;
            display: inline-block;
            min-width: 100px;
        }
        .click-button {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background-color: #6f42c1;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 5px 15px rgba(111, 66, 193, 0.3);
        }
        .click-button:hover {
            background-color: #5a359e;
            transform: translateY(-2px);
        }
        .click-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(111, 66, 193, 0.3);
        }

        /* Section du pied de page */
        .footer {
            margin-top: 40px;
            padding: 20px;
            text-align: center;
            color: #777;
            font-size: 0.9em;
            border-top: 1px solid #e0e0e0;
            background-color: #ffffff;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        /* Adaptations pour les écrans plus petits (responsive design) */
        @media (max-width: 768px) {
            .navbar a {
                margin: 0 10px;
                font-size: 1em;
            }
            .header h1 {
                font-size: 2em;
            }
            .section h2 {
                font-size: 1.8em;
            }
            .download-button, .click-button {
                font-size: 1.3em;
                padding: 15px 30px;
            }
            .header, .main-content, .footer {
                padding: 15px;
            }
            .section {
                padding: 20px;
            }
            .clicker-display {
                font-size: 2.5em;
            }
        }

        @media (max-width: 480px) {
            .navbar a {
                display: block;
                margin: 10px 0;
            }
            .header h1 {
                font-size: 1.6em;
            }
            .section h2 {
                font-size: 1.5em;
            }
            .download-button, .click-button {
                font-size: 1.1em;
                padding: 12px 25px;
            }
            .clicker-display {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <!-- Ajout du lien "Accueil" qui pointe vers game_collection_hub/ -->
        <a href="game_collection_hub/" style="margin-right: 20px;"><i class="fas fa-home"></i> Accueil</a>
        <a href="#" id="assistance-link"><i class="fas fa-life-ring"></i> Assistance</a>
    </nav>

    <div class="header">
        <h1>Bienvenue sur la page de téléchargement de Mon Super Jeu !</h1>
        <p>Préparez-vous à une aventure inoubliable !</p>
        <!-- Image principale du jeu sous l'en-tête -->
        <img src="photo/picture1.png" alt="[Image de Mon Super Jeu]" class="content-image">
    </div>

    <div class="main-content">
        <div class="section">
            <h2>🎮 À propos de Mon Super Jeu</h2>
            <p>Mon Super Jeu est un clicker basique mais fun qui peut faire passé le temps avec un system de theme il sera mis a jours régulièrement.</p>
            <img src="photo/picture2.png" alt="[Image d'Aventure Fantastique]" class="content-image">
            <p>Merci d'avance et si il y a un problème contactez-nous sur Discord : <a href="https://discord.gg/AX2VKE7A" target="_blank">https://discord.gg/AX2VKE7A</a></p>
        </div>

        <div class="section download-button-container">
            <h2>⬇️ Téléchargez le jeu maintenant !</h2>
            <button id="download-button" class="download-button">
                <i class="fas fa-download"></i> Télécharger le clicker (Windows)
            </button>
            <p id="download-count" style="margin-top: 10px; font-size: 1.1em; color: #555;">Nombre de téléchargements : <span id="global-download-count">0</span></p>
            <!-- Nouveau message d'état pour le téléchargement -->
            <p id="download-status-message" style="color: red; font-weight: bold; margin-top: 10px;"></p>
            <div class="warning">
                <ul>
                    <li><strong>Attention :</strong> Le fichier est un exécutable (.exe). Votre navigateur ou votre antivirus peut afficher un avertissement de sécurité. C'est un comportement normal pour les fichiers .exe. Veuillez confirmer le téléchargement si vous êtes sûr de la source et que le fichier est fiable.</li>
                </ul>
            </div>
        </div>

        <div class="section clicker-container">
            <h2>👆 Entraînez-vous avec notre Clicker !</h2>
            <p>Cliquez autant de fois que possible sur le bouton ci-dessous pour voir votre score augmenter. Un petit échauffement avant l'aventure !</p>
            <div class="clicker-display" id="click-count">0</div>
            <button class="click-button" id="click-button">
                <i class="fas fa-hand-pointer"></i> Cliquez-moi !
            </button>
            <img src="" alt="[Image d'un Jeu Clicker]" class="content-image" style="margin-top: 20px;">
        </div>

        <div class="section">
            <h2>⚙️ Guide d'Installation</h2>
            <p>Suivez ces étapes simples pour installer et commencer à jouer à Mon Super Jeu :</p>
            <ol>
                <li><strong>Télécharger le Fichier :</strong> Cliquez sur le bouton "Télécharger le clicker" ci-dessus. Le fichier `.exe` sera téléchargé sur votre ordinateur (généralement dans le dossier "Téléchargements").</li>
                <li><strong>Placer le Fichier :</strong> Pour pouvoir l'exécuter sans problème, ajoutez un nouveau dossier et insérez `clicker.exe` dedans. Ensuite, cliquez dessus pour jouer.</li>
            </ol>
            <p>Si vous rencontrez des problèmes, assurez-vous que votre système répond aux <a href="#requirements">exigences minimales</a> ou consultez la section de dépannage.</p>
        </div>

        <div class="section" id="requirements">
            <h2>💻 Configuration Requise (Minimum)</h2>
            <p>Pour une expérience de jeu fluide, nous recommandons la configuration minimale suivante :</p>
            <ul>
                <li><strong>Système d'exploitation :</strong> Windows 7 / 8 / 10 / 11 (64-bit)</li>
                <li><strong>Processeur :</strong> Intel Core i3 ou équivalent</li>
                <li><strong>Mémoire vive (RAM) :</strong> 4 Go</li>
                <li><strong>Carte Graphique :</strong> Compatible DirectX 11 (ex: NVIDIA GeForce GTX 460 / AMD Radeon HD 5850 ou équivalent)</li>
                <li><strong>Espace Disque :</strong> 2 Go d'espace libre</li>
                <li><strong>DirectX :</strong> Version 11</li>
            </ul>
            <p>Aucun besoin d'internet pour le moment.</p>
        </div>

        <div class="section">
            <h2>🛠️ Dépannage Courant</h2>
            <p>Si vous rencontrez des difficultés lors du téléchargement ou de l'installation, voici quelques solutions :</p>
            <ul>
                <li><strong>Avertissement du Navigateur :</strong> Si votre navigateur bloque le téléchargement, cherchez une option "Conserver" ou "Télécharger quand même" dans la notification.</li>
                <li><strong>Antivirus :</strong> Votre logiciel antivirus pourrait mettre en quarantaine le fichier. Ajoutez le jeu à la liste d'exceptions de votre antivirus si vous lui faites confiance.</li>
                <li><strong>Espace Disque :</strong> Assurez-vous d'avoir suffisamment d'espace libre sur votre disque dur avant de lancer l'installation.</li>
                <li><strong>Mises à jour Windows :</strong> Assurez-vous que votre système d'exploitation est à jour.</li>
                <li><strong>Pilotes Graphiques :</strong> Vérifiez que vos pilotes de carte graphique sont à jour.</li>
            </ul>
            <p>Si le problème persiste, n'hésitez pas à nous contacter via notre page de support (vous pouvez ajouter un lien ici).</p>
        </div>
    </div>

    <div class="footer">
        <p>&copy; 2024 Mon Super Jeu. Tous droits réservés.</p>
    </div>

    <script type="module">
        // Importez les fonctions nécessaires de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc, increment, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";


        // Utilisez les variables globales fournies par l'environnement Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Définition de DOWNLOAD_DOC_PATH ici pour qu'il soit disponible globalement
        const DOWNLOAD_DOC_PATH = `/artifacts/${appId}/public/data/globalCounts/downloadCounter`;

        // Initialisez Firebase
        let app = null;
        let db = null;
        let auth = null;
        let userId = null; // Variable pour stocker l'ID utilisateur
        
        // Eléments UI pour les messages d'état
        const downloadCountElement = document.getElementById('global-download-count');
        const downloadStatusMessage = document.getElementById('download-status-message');


        // Initialisation de Firebase
        // Assurez-vous que firebaseConfig est un objet valide et contient un projectId
        if (firebaseConfig && typeof firebaseConfig === 'object' && firebaseConfig.projectId && typeof firebaseConfig.projectId === 'string' && firebaseConfig.projectId.length > 0) {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                console.log("Firebase initialisé avec succès.");

                // Authentification anonyme pour le compteur de téléchargement
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Utilisateur connecté :", userId);
                        loadGlobalDownloadCount();
                    } else {
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                            console.log("Connexion anonyme réussie.");
                            userId = auth.currentUser?.uid || crypto.randomUUID(); // S'assurer que userId est défini
                            loadGlobalDownloadCount();
                        } catch (error) {
                            console.error("Erreur de connexion anonyme ou avec token :", error);
                            userId = crypto.randomUUID(); // Fallback si l'authentification échoue
                            downloadStatusMessage.style.color = "orange";
                            downloadStatusMessage.textContent = "Le compteur global pourrait ne pas fonctionner (problème d'authentification Firebase).";
                            setTimeout(() => { downloadStatusMessage.textContent = ""; }, 7000);
                        }
                    }
                });
            } catch (initError) {
                console.error("Erreur lors de l'initialisation de Firebase (initializeApp) :", initError.message);
                downloadStatusMessage.style.color = "red";
                downloadStatusMessage.textContent = "Erreur: Le compteur de téléchargement global n'est pas disponible (problème lors de l'initialisation de Firebase).";
                downloadCountElement.textContent = "N/A";
                userId = crypto.randomUUID();
            }
        } else {
            console.error("Initialisation Firebase ignorée : 'projectId' non trouvé ou non valide dans firebaseConfig.");
            downloadStatusMessage.style.color = "red";
            downloadStatusMessage.textContent = "Le compteur de téléchargement global n'est pas disponible (configuration Firebase incomplète).";
            downloadCountElement.textContent = "N/A";
            userId = crypto.randomUUID();
        }


        // JavaScript pour le jeu de clicker (inchangé, fonctionne indépendamment)
        let clicks = 0;
        const clickCountElementClicker = document.getElementById('click-count'); // Renommé pour éviter conflit
        const clickButton = document.getElementById('click-button');

        clickButton.addEventListener('click', () => {
            clicks++;
            clickCountElementClicker.textContent = clicks;
        });

        // JavaScript pour le lien d'assistance (inchangé, fonctionne indépendamment)
        const assistanceLink = document.getElementById('assistance-link');
        assistanceLink.addEventListener('click', (event) => {
            event.preventDefault();
            showCustomPrompt("Voulez-vous rejoindre notre serveur Discord pour l'assistance ? Tapez 'oui' pour confirmer.", (response) => {
                if (response && response.toLowerCase() === 'oui') {
                    window.open("https://discord.gg/AX2VKE7A", "_blank");
                } else {
                    console.log("Accès Discord annulé par l'utilisateur.");
                }
            });
        });

        // Boîte de dialogue personnalisée (inchangée, fonctionne indépendamment)
        function showCustomPrompt(message, callback) {
            const dialogOverlay = document.createElement('div');
            dialogOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;

            const dialogBox = document.createElement('div');
            dialogBox.style.cssText = `
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
                text-align: center;
                font-family: 'Inter', sans-serif;
            `;

            const messageP = document.createElement('p');
            messageP.textContent = message;
            dialogBox.appendChild(messageP);

            const inputField = document.createElement('input');
            inputField.type = 'text';
            inputField.style.cssText = `
                padding: 8px;
                margin-top: 10px;
                border: 1px solid #ccc;
                border-radius: 4px;
                width: 80%;
                max-width: 250px;
            `;
            dialogBox.appendChild(inputField);

            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = `
                margin-top: 20px;
            `;

            const confirmButton = document.createElement('button');
            confirmButton.textContent = 'Confirmer';
            confirmButton.style.cssText = `
                background-color: #28a745;
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                margin-right: 10px;
            `;
            confirmButton.onclick = () => {
                document.body.removeChild(dialogOverlay);
                callback(inputField.value);
            };
            buttonContainer.appendChild(confirmButton);

            const cancelButton = document.createElement('button');
            cancelButton.textContent = 'Annuler';
            cancelButton.style.cssText = `
                background-color: #dc3545;
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
            `;
            cancelButton.onclick = () => {
                document.body.removeChild(dialogOverlay);
                callback(null);
            };
            buttonContainer.appendChild(cancelButton);

            dialogBox.appendChild(buttonContainer);
            dialogOverlay.appendChild(dialogBox);
            document.body.appendChild(dialogOverlay);
            inputField.focus();
        }

        // Fonction pour charger le compteur global
        async function loadGlobalDownloadCount() {
            if (!db || !auth || !userId) {
                console.warn("Firebase ou User ID non disponible, ne peut pas charger le compteur de téléchargement.");
                return;
            }
            try {
                const docRef = doc(db, DOWNLOAD_DOC_PATH);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    downloadCountElement.textContent = data.count || 0;
                } else {
                    await setDoc(docRef, { count: 0 });
                    downloadCountElement.textContent = 0;
                }
            } catch (error) {
                console.error("Erreur lors du chargement du compteur de téléchargement global :", error);
                downloadCountElement.textContent = "Erreur";
                downloadStatusMessage.style.color = "red";
                downloadStatusMessage.textContent = "Impossible de charger le compteur de téléchargement (problème de lecture Firebase).";
                setTimeout(() => { downloadStatusMessage.textContent = ""; }, 7000);
            }
        }

        // Écouteur d'événement pour le bouton de téléchargement
        const downloadButton = document.getElementById('download-button'); // Déplacé ici pour être sûr
        downloadButton.addEventListener('click', async (event) => {
            event.preventDefault();

            // Étape 1: Tenter IMMÉDIATEMENT le téléchargement du fichier.
            console.log("Tentative de déclenchement du téléchargement : game/clicker.exe");
            window.location.href = 'game/clicker.exe'; 
            
            // Étape 2: Afficher un message d'état à l'utilisateur.
            downloadStatusMessage.style.color = "blue";
            downloadStatusMessage.textContent = "Le téléchargement devrait commencer sous peu. Si ce n'est pas le cas, veuillez vérifier vos téléchargements ou la disponibilité du fichier.";
            setTimeout(() => {
                downloadStatusMessage.textContent = "";
            }, 7000);

            // Étape 3: Mettre à jour le compteur global via Firebase de manière ASYNCHRONE.
            if (db && auth && userId) {
                try {
                    const docRef = doc(db, DOWNLOAD_DOC_PATH);
                    await updateDoc(docRef, {
                        count: increment(1)
                    });
                    
                    const currentCount = parseInt(downloadCountElement.textContent) || 0;
                    downloadCountElement.textContent = currentCount + 1;
                    console.log("Compteur de téléchargement global incrémenté avec succès.");

                } catch (error) {
                    console.error("Erreur lors de l'incrémentation du compteur de téléchargement global :", error);
                    downloadStatusMessage.style.color = "red";
                    downloadStatusMessage.textContent = "Le jeu se télécharge, mais une erreur est survenue lors de la mise à jour du compteur global (permissions ou connexion Firebase).";
                    // Utilisez la boîte de dialogue personnalisée pour l'erreur Firebase
                    showCustomPrompt("Une erreur est survenue lors de la mise à jour du compteur de téléchargement. Vérifiez les règles Firebase.", () => {});
                    setTimeout(() => { downloadStatusMessage.textContent = ""; }, 7000);
                }
            } else {
                console.warn("Firebase non initialisé ou User ID non disponible. Le compteur global de téléchargement ne sera pas mis à jour pour ce clic.");
                downloadStatusMessage.style.color = "orange";
                downloadStatusMessage.textContent = "Le jeu se télécharge, mais le compteur global n'a pas pu être mis à jour (service Firebase indisponible).";
                setTimeout(() => { downloadStatusMessage.textContent = ""; }, 7000);
            }
        });

        // Optionnel : Utiliser onSnapshot pour une mise à jour en temps réel (pour tous les clients)
        /*
        onAuthStateChanged(auth, (user) => {
            if (user) {
                const docRef = doc(db, DOWNLOAD_DOC_PATH);
                onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        downloadCountElement.textContent = data.count || 0;
                    } else {
                        console.log("Le document du compteur n'existe pas encore.");
                        downloadCountElement.textContent = 0;
                    }
                }, (error) => {
                    console.error("Erreur lors de l'écoute du compteur de téléchargement :", error);
                });
            }
        });
        */
    </script>
</body>
</html>
